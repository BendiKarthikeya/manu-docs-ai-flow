#!/usr/bin/env node

/**
 * Twilio WhatsApp Integration Test Script
 * Tests the WhatsApp message delivery functionality
 */

import axios from 'axios';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('🔍 TWILIO WHATSAPP INTEGRATION TEST');
console.log('===================================\n');

// Load environment variables
const envPath = path.join(__dirname, '.env');
let config = {};

if (fs.existsSync(envPath)) {
    const envContent = fs.readFileSync(envPath, 'utf8');
    
    config.accountSid = envContent.match(/VITE_TWILIO_ACCOUNT_SID=(.+)/)?.[1];
    config.authToken = envContent.match(/VITE_TWILIO_AUTH_TOKEN=(.+)/)?.[1];
    config.whatsappNumber = envContent.match(/VITE_TWILIO_WHATSAPP_NUMBER=(.+)/)?.[1];
    
    console.log('📋 Configuration Status:');
    console.log(`✅ Account SID: ${config.accountSid ? 'LOADED' : '❌ MISSING'}`);
    console.log(`✅ Auth Token: ${config.authToken ? 'LOADED' : '❌ MISSING'}`);
    console.log(`✅ WhatsApp Number: ${config.whatsappNumber ? 'LOADED' : '❌ MISSING'}\n`);
} else {
    console.log('❌ .env file not found\n');
    process.exit(1);
}

// Test 1: Check Twilio Account Status
async function testAccountStatus() {
    console.log('1. Testing Twilio Account Status...');
    console.log('----------------------------------');
    
    try {
        const response = await axios.get(
            `https://api.twilio.com/2010-04-01/Accounts/${config.accountSid}.json`,
            {
                auth: {
                    username: config.accountSid,
                    password: config.authToken
                }
            }
        );
        
        console.log(`✅ Account Status: ${response.data.status}`);
        console.log(`✅ Account Name: ${response.data.friendly_name}`);
        console.log(`✅ Account Type: ${response.data.type}`);
        return true;
    } catch (error) {
        console.log('❌ Account Status Check Failed:');
        console.log(`   Error: ${error.response?.data?.message || error.message}`);
        return false;
    }
}

// Test 2: Send Test WhatsApp Message
async function sendTestMessage(phoneNumber = '+919491392074') {
    console.log('\n2. Testing WhatsApp Message Delivery...');
    console.log('---------------------------------------');
    
    const testMessage = `🤖 *Test message from ManuDocs AI*

Your Twilio WhatsApp integration is working correctly!

📱 From: ${config.whatsappNumber}
📅 Timestamp: ${new Date().toLocaleString()}

_This is an automated test message._`;

    const payload = new URLSearchParams({
        From: config.whatsappNumber,
        To: `whatsapp:${phoneNumber}`,
        Body: testMessage
    });

    try {
        const response = await axios.post(
            `https://api.twilio.com/2010-04-01/Accounts/${config.accountSid}/Messages.json`,
            payload,
            {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                auth: {
                    username: config.accountSid,
                    password: config.authToken
                }
            }
        );

        console.log(`✅ Message Sent Successfully!`);
        console.log(`   Message SID: ${response.data.sid}`);
        console.log(`   Status: ${response.data.status}`);
        console.log(`   To: ${response.data.to}`);
        console.log(`   From: ${response.data.from}`);
        return true;
    } catch (error) {
        console.log('❌ Message Delivery Failed:');
        console.log(`   Error: ${error.response?.data?.message || error.message}`);
        if (error.response?.data?.more_info) {
            console.log(`   More Info: ${error.response.data.more_info}`);
        }
        return false;
    }
}

// Test 3: Send Document Summary Test
async function sendDocumentSummaryTest(phoneNumber = '+919491392074') {
    console.log('\n3. Testing Document Summary Delivery...');
    console.log('---------------------------------------');
    
    const summaryMessage = `📄 *Document Summary*
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 *test-document.pdf*

📝 *Summary:*
This is a test document summary generated by ManuDocs AI. The document contains sample content for testing the WhatsApp integration functionality. Key points include system testing, integration verification, and delivery confirmation.

📊 *Details:*
• Word count: 1,250
• Processing time: 3s
• File type: application/pdf

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;

    const payload = new URLSearchParams({
        From: config.whatsappNumber,
        To: `whatsapp:${phoneNumber}`,
        Body: summaryMessage
    });

    try {
        const response = await axios.post(
            `https://api.twilio.com/2010-04-01/Accounts/${config.accountSid}/Messages.json`,
            payload,
            {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                auth: {
                    username: config.accountSid,
                    password: config.authToken
                }
            }
        );

        console.log(`✅ Document Summary Sent Successfully!`);
        console.log(`   Message SID: ${response.data.sid}`);
        console.log(`   Status: ${response.data.status}`);
        return true;
    } catch (error) {
        console.log('❌ Document Summary Delivery Failed:');
        console.log(`   Error: ${error.response?.data?.message || error.message}`);
        return false;
    }
}

// Main test execution
async function runTests() {
    console.log('🚀 Starting WhatsApp Integration Tests...\n');
    
    const results = {
        accountStatus: false,
        testMessage: false,
        documentSummary: false
    };
    
    // Test 1: Account Status
    results.accountStatus = await testAccountStatus();
    
    if (results.accountStatus) {
        // Test 2: Test Message
        results.testMessage = await sendTestMessage();
        
        if (results.testMessage) {
            // Test 3: Document Summary
            results.documentSummary = await sendDocumentSummaryTest();
        }
    }
    
    // Summary
    console.log('\n📋 TEST RESULTS SUMMARY');
    console.log('=======================');
    console.log(`Account Status: ${results.accountStatus ? '✅ PASS' : '❌ FAIL'}`);
    console.log(`Test Message: ${results.testMessage ? '✅ PASS' : '❌ FAIL'}`);
    console.log(`Document Summary: ${results.documentSummary ? '✅ PASS' : '❌ FAIL'}`);
    
    const allPassed = results.accountStatus && results.testMessage && results.documentSummary;
    
    console.log(`\n🎯 Overall Status: ${allPassed ? '✅ ALL TESTS PASSED' : '❌ SOME TESTS FAILED'}`);
    
    if (allPassed) {
        console.log('\n🎉 WhatsApp integration is working perfectly!');
        console.log('   Users can now receive document summaries via WhatsApp.');
    } else {
        console.log('\n🔧 Action Required:');
        if (!results.accountStatus) {
            console.log('   - Check Twilio credentials in .env file');
            console.log('   - Verify account is active and has sufficient balance');
        }
        if (!results.testMessage) {
            console.log('   - Check WhatsApp number format');
            console.log('   - Verify WhatsApp Business API is enabled');
        }
        if (!results.documentSummary) {
            console.log('   - Check message formatting and length limits');
        }
    }
    
    console.log('\n📞 Need help? Check Twilio Console: https://console.twilio.com/');
}

// Run the tests
runTests().catch(error => {
    console.error('❌ Test execution failed:', error.message);
    process.exit(1);
});